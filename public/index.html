<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon App Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <!-- Bibliothèque Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>Mon App Store</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html" class="active">Accueil</a></li>
                    <li><a href="login.html" id="login-btn">Connexion</a></li>
                    <li><a href="register.html" class="register-btn">Inscription</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h2>Découvrez mes applications</h2>
            <p>Une collection d'applications créées avec passion</p>
        </div>
    </section>

    <main>
        <div class="container">
            <section class="featured-apps">
                <h3>Applications vedettes</h3>
                <div class="app-grid" id="featured-apps-container">
                    <!-- Les applications vedettes seront insérées ici par JavaScript -->
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i> Chargement des applications...
                    </div>
                </div>
            </section>

            <section class="all-apps">
                <h3>Toutes les applications</h3>
                <div class="app-grid" id="all-apps-container">
                    <!-- Toutes les applications seront insérées ici par JavaScript -->
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mon App Store. Tous droits réservés.</p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Connexion</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn primary">Se connecter</button>
            </form>
            <p>Pas encore de compte? <a href="register.html">S'inscrire</a></p>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://dbksdxqzbbsklzfntfiq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRia3NkeHF6YmJza2x6Zm50ZmlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NzAzOTYsImV4cCI6MjA2MzI0NjM5Nn0.Cv-FBgmwCuzAqd6vThGoancA85C1X8o_GP59oPuxbZg';

        // Vérifier que la bibliothèque Supabase est bien chargée
        if (typeof supabase !== 'undefined') {
            window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Client Supabase initialisé avec succès');
        } else {
            console.error('Erreur: La bibliothèque Supabase n\'est pas chargée correctement');
        }
    </script>

    <script>
        // Variables globales
        let currentUser = null;
        let isUserAdmin = false;
        let appsData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifier si l'utilisateur est connecté
            await checkAuthStatus();

            // Gérer le modal de connexion
            setupLoginModal();

            // Charger les applications
            await loadApps();
        });

        // Vérifier si l'utilisateur est déjà connecté
        async function checkAuthStatus() {
            try {
                const { data, error } = await window.supabaseClient.auth.getSession();

                if (error) {
                    console.error("Erreur de session:", error);
                    return false;
                }

                if (data?.session) {
                    // Récupérer les données utilisateur
                    const { data: userData, error: userError } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', data.session.user.id)
                        .single();

                    if (userError && userError.code !== 'PGRST116') {
                        console.error("Erreur utilisateur:", userError);
                    }

                    // Stocker l'utilisateur actuel
                    currentUser = {
                        id: data.session.user.id,
                        email: data.session.user.email,
                        name: userData?.name || 'Utilisateur',
                        isAdmin: userData?.is_admin || false
                    };
                    isUserAdmin = userData?.is_admin || false;

                    // Mettre à jour l'interface utilisateur
                    updateAuthUI();
                    return true;
                }
            } catch (error) {
                console.error("Erreur de vérification d'authentification:", error);
            }

            return false;
        }

        // Mettre à jour l'interface selon l'état de connexion
        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.querySelector('.register-btn');

            if (currentUser) {
                // L'utilisateur est connecté
                if (loginBtn) {
                    loginBtn.textContent = currentUser.name;
                    loginBtn.href = 'profile.html';

                    // Supprimer le menu déroulant s'il existe déjà
                    const existingDropdown = document.querySelector('.dropdown-menu');
                    if (existingDropdown) {
                        existingDropdown.remove();
                    }

                    // Ajouter un menu déroulant pour le profil et la déconnexion
                    const dropdownMenu = document.createElement('div');
                    dropdownMenu.className = 'dropdown-menu';

                    let menuHTML = `
            <ul>
              <li><a href="profile.html" id="profile-link">Mon Profil</a></li>
              <li><a href="#" id="logout-link">Déconnexion</a></li>
            </ul>
          `;

                    // Ajouter le lien admin si l'utilisateur est admin
                    if (isUserAdmin) {
                        menuHTML = `
              <ul>
                <li><a href="admin/index.html" id="admin-link">Administration</a></li>
                <li><a href="profile.html" id="profile-link">Mon Profil</a></li>
                <li><a href="#" id="logout-link">Déconnexion</a></li>
              </ul>
            `;
                    }

                    dropdownMenu.innerHTML = menuHTML;

                    // Ajouter le menu après le bouton de connexion
                    loginBtn.parentNode.appendChild(dropdownMenu);

                    // Ajouter les événements pour le menu
                    const logoutLink = document.getElementById('logout-link');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', async (e) => {
                            e.preventDefault();
                            await logout();
                        });
                    }

                    // Afficher/cacher le menu au clic sur le nom d'utilisateur
                    loginBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        dropdownMenu.classList.toggle('show');
                        return false;
                    });
                }

                // Cacher le bouton d'inscription si l'utilisateur est connecté
                if (registerBtn) {
                    registerBtn.style.display = 'none';
                }
            } else {
                // L'utilisateur n'est pas connecté
                if (loginBtn) {
                    loginBtn.textContent = 'Connexion';
                    loginBtn.href = 'login.html';

                    // Supprimer le menu déroulant s'il existe
                    const dropdownMenu = document.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.remove();
                    }
                }

                // Afficher le bouton d'inscription si l'utilisateur n'est pas connecté
                if (registerBtn) {
                    registerBtn.style.display = 'block';
                }
            }
        }

        // Configurer le modal de connexion
        function setupLoginModal() {
            const loginBtn = document.getElementById('login-btn');
            const loginModal = document.getElementById('login-modal');
            const closeBtn = document.querySelector('.close');

            // Ne pas afficher le modal si l'utilisateur est connecté
            if (currentUser) return;

            // Ouvrir le modal de connexion
            if (loginBtn) {
                loginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginModal.style.display = 'flex';
                });
            }

            // Fermer le modal quand on clique sur la croix
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    loginModal.style.display = 'none';
                });
            }

            // Fermer le modal quand on clique en dehors du contenu
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.style.display = 'none';
                }
            });

            // Gérer le formulaire de connexion
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    await login(email, password);
                });
            }
        }

        // Connexion d'un utilisateur
        async function login(email, password) {
            try {
                // Désactiver le bouton pendant la connexion
                const submitBtn = document.querySelector('#login-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
                }

                // Connexion avec Supabase
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                // Réinitialiser le bouton
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Se connecter';
                }

                if (error) throw error;

                // Récupérer les données de l'utilisateur
                const { data: userData, error: userError } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (userData) {
                    currentUser = {
                        id: data.user.id,
                        email: data.user.email,
                        name: userData.name,
                        isAdmin: userData.is_admin || false
                    };
                    isUserAdmin = userData.is_admin || false;
                } else {
                    // Si l'utilisateur n'existe pas dans notre table, l'ajouter
                    await checkAuthStatus();
                }

                // Fermer le modal de connexion
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'none';
                }

                // Mettre à jour l'interface
                updateAuthUI();

                showMessage(`Connexion réussie !`, 'success');

                return true;
            } catch (error) {
                console.error("Erreur de connexion:", error);

                let errorMessage = 'Identifiants incorrects.';
                if (error.message) {
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Email ou mot de passe incorrect.';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Veuillez confirmer votre email avant de vous connecter.';
                    } else {
                        errorMessage = 'Erreur: ' + error.message;
                    }
                }

                showMessage(errorMessage, 'error');

                // Réinitialiser le bouton si ce n'est pas déjà fait
                const loginButton = document.querySelector('#login-form button[type="submit"]');
                if (loginButton && loginButton.disabled) {
                    loginButton.innerHTML = 'Se connecter';
                    loginButton.disabled = false;
                }

                return false;
            }
        }

        // Déconnexion d'un utilisateur
        async function logout() {
            try {
                const { error } = await window.supabaseClient.auth.signOut();

                if (error) throw error;

                currentUser = null;
                isUserAdmin = false;

                // Mettre à jour l'interface
                updateAuthUI();

                showMessage('Vous avez été déconnecté.', 'info');

                return true;
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
                showMessage('Erreur lors de la déconnexion.', 'error');
                return false;
            }
        }

        // Charger les applications depuis Supabase
        async function loadApps() {
            const featuredAppsContainer = document.getElementById('featured-apps-container');
            const allAppsContainer = document.getElementById('all-apps-container');

            if (!featuredAppsContainer || !allAppsContainer) return;

            try {
                // Afficher un indicateur de chargement
                featuredAppsContainer.innerHTML = `<div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Chargement des applications...</div>`;
                allAppsContainer.innerHTML = `<div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Chargement des applications...</div>`;

                // Charger les applications depuis Supabase
                const { data, error } = await window.supabaseClient
                    .from('apps')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                appsData = data || [];

                // Vider les conteneurs
                featuredAppsContainer.innerHTML = '';
                allAppsContainer.innerHTML = '';

                // Vérifier si des applications ont été trouvées
                if (appsData.length === 0) {
                    featuredAppsContainer.innerHTML = '<p>Aucune application vedette disponible.</p>';
                    allAppsContainer.innerHTML = '<p>Aucune application disponible.</p>';
                    return;
                }

                // Afficher les applications vedettes
                const featuredApps = appsData.filter(app => app.featured);

                if (featuredApps.length > 0) {
                    featuredApps.forEach(app => {
                        const appCard = createAppCard(app);
                        featuredAppsContainer.appendChild(appCard);
                    });
                } else {
                    featuredAppsContainer.innerHTML = '<p>Aucune application vedette disponible.</p>';
                }

                // Afficher toutes les applications
                if (appsData.length > 0) {
                    appsData.forEach(app => {
                        const appCard = createAppCard(app);
                        allAppsContainer.appendChild(appCard);
                    });
                } else {
                    allAppsContainer.innerHTML = '<p>Aucune application disponible.</p>';
                }
            } catch (error) {
                console.error("Erreur lors du chargement des applications:", error);
                featuredAppsContainer.innerHTML = '<p>Erreur lors du chargement des applications vedettes.</p>';
                allAppsContainer.innerHTML = '<p>Erreur lors du chargement des applications.</p>';
            }
        }

        // Créer une carte d'application
        function createAppCard(app) {
            const card = document.createElement('div');
            card.className = 'app-card';

            // Création des étoiles pour l'affichage de la note
            const starsHTML = generateStars(app.rating);

            card.innerHTML = `
        <img src="${app.banner}" alt="${app.name}">
        <img src="${app.icon}" alt="${app.name} icon" class="app-icon">
        <div class="app-info">
          <h4>${app.name}</h4>
          <div class="app-developer">${app.developer}</div>
          <div class="app-description">${app.short_description}</div>
          <div class="app-meta">
            <div class="app-rating">
              <div class="stars">${starsHTML}</div>
              <div class="rating-value">${app.rating.toFixed(1)}</div>
            </div>
            <a href="app-details.html?id=${app.id}" class="btn secondary">Voir</a>
          </div>
        </div>
      `;

            return card;
        }

        // Générer les étoiles pour l'affichage de la note
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            let stars = '';

            // Étoiles pleines
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }

            // Demi-étoile si nécessaire
            if (halfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }

            // Étoiles vides
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }

            return stars;
        }

        // Afficher des messages à l'utilisateur
        function showMessage(message, type = 'info') {
            // Supprimer les messages existants
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            const messageContainer = document.createElement('div');
            messageContainer.className = `message ${type}`;
            messageContainer.textContent = message;

            document.body.appendChild(messageContainer);

            // Afficher le message pendant 3 secondes
            setTimeout(() => {
                messageContainer.remove();
            }, 3000);
        }