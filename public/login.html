<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Mon App Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <!-- Bibliothèque Supabase - Utilisez la version CDN qui fonctionne correctement -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>Mon App Store</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Accueil</a></li>
                    <li><a href="login.html" class="active">Connexion</a></li>
                    <li><a href="register.html" class="register-btn">Inscription</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <section class="auth-section">
                <h2>Connexion</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn primary">Se connecter</button>
                </form>
                <p class="auth-redirect">Pas encore de compte? <a href="register.html">S'inscrire</a></p>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mon App Store. Tous droits réservés.</p>
        </div>
    </footer>

    <!-- Assurez-vous de charger les scripts dans le bon ordre -->
    <script>
        // Configuration Supabase directement intégrée pour éviter les problèmes de chargement
        const supabaseUrl = 'https://dbksdxqzbbsklzfntfiq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRia3NkeHF6YmJza2x6Zm50ZmlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NzAzOTYsImV4cCI6MjA2MzI0NjM5Nn0.Cv-FBgmwCuzAqd6vThGoancA85C1X8o_GP59oPuxbZg';

        // Vérifier que la bibliothèque Supabase est bien chargée
        if (typeof supabase !== 'undefined') {
            window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Client Supabase initialisé avec succès');
        } else {
            console.error('Erreur: La bibliothèque Supabase n\'est pas chargée correctement');
        }
    </script>

    <script>
        // Code d'authentification intégré pour éviter les problèmes de dépendances
        document.addEventListener('DOMContentLoaded', () => {
            // Vérifier si l'utilisateur est déjà connecté
            checkAuthStatus();

            // Gestionnaire de soumission du formulaire de connexion
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    // Désactiver le bouton pendant la connexion
                    const submitBtn = loginForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
                    }

                    try {
                        // Connexion avec Supabase
                        const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                            email,
                            password
                        });

                        if (error) throw error;

                        showMessage('Connexion réussie !', 'success');

                        // Rediriger vers la page d'accueil après un court délai
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);

                    } catch (error) {
                        console.error("Erreur de connexion:", error);

                        let errorMessage = 'Identifiants incorrects.';
                        if (error.message) {
                            if (error.message.includes('Invalid login credentials')) {
                                errorMessage = 'Email ou mot de passe incorrect.';
                            } else if (error.message.includes('Email not confirmed')) {
                                errorMessage = 'Veuillez confirmer votre email avant de vous connecter.';
                            } else {
                                errorMessage = 'Erreur: ' + error.message;
                            }
                        }

                        showMessage(errorMessage, 'error');

                        // Réactiver le bouton
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Se connecter';
                        }
                    }
                });
            }
        });

        // Vérifier si l'utilisateur est déjà connecté
        async function checkAuthStatus() {
            try {
                const { data, error } = await window.supabaseClient.auth.getSession();

                if (error) {
                    console.error("Erreur de session:", error);
                    return false;
                }

                if (data?.session) {
                    // L'utilisateur est déjà connecté, rediriger vers la page d'accueil
                    showMessage('Vous êtes déjà connecté. Redirection...', 'info');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    return true;
                }
            } catch (error) {
                console.error("Erreur de vérification d'authentification:", error);
            }

            return false;
        }

        // Afficher des messages à l'utilisateur
        function showMessage(message, type = 'info') {
            // Supprimer les messages existants
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            const messageContainer = document.createElement('div');
            messageContainer.className = `message ${type}`;
            messageContainer.textContent = message;

            document.body.appendChild(messageContainer);

            // Afficher le message pendant 3 secondes
            setTimeout(() => {
                messageContainer.remove();
            }, 3000);
        }
    </script>
</body>

</html>