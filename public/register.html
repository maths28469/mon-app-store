<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription - Mon App Store</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <!-- Bibliothèque Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="index.html">
                    <img src="assets/logo.png" alt="Mon App Store" class="logo-img">
                    <h1>Mon App Store</h1>
                </a>
            </div>
            <nav id="main-nav">
                <!-- Sera remplacé dynamiquement par auth-manager.js -->
                <div class="nav-loader">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <section class="auth-section">
                <h2>Créer un compte</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="name">Nom complet</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" required minlength="6">
                        <small>Le mot de passe doit comporter au moins 6 caractères</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmer le mot de passe</label>
                        <input type="password" id="confirm-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn primary">S'inscrire</button>
                </form>
                <p class="auth-redirect">Déjà un compte? <a href="login.html">Se connecter</a></p>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="assets/logo.png" alt="Mon App Store" class="logo-img-small">
                    <h3>Mon App Store</h3>
                </div>
                <div class="footer-links">
                    <h4>Liens rapides</h4>
                    <ul>
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="categories.html">Catégories</a></li>
                        <li><a href="#" id="footer-login-link">Connexion</a></li>
                        <li><a href="register.html" id="footer-register-link">Inscription</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <p><i class="fas fa-envelope"></i> contact@monappstore.com</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-github"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Mon App Store. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal pour les liens de connexion rapide -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Connexion</h2>
                <span class="close" id="close-login-modal">&times;</span>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn primary full-width">Se connecter</button>
            </form>
            <div class="modal-footer">
                <p>Pas encore de compte? <a href="register.html" id="register-link">S'inscrire</a></p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifier si l'utilisateur est déjà connecté
            await checkAuthStatus();

            if (currentUser) {
                // L'utilisateur est déjà connecté, rediriger vers la page d'accueil
                showMessage('Vous êtes déjà connecté. Redirection...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                return;
            }

            // Configurer le formulaire d'inscription
            setupRegisterForm();
        });

        // Configurer le formulaire d'inscription
        function setupRegisterForm() {
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const name = document.getElementById('name').value;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    // Vérifier si les mots de passe correspondent
                    if (password !== confirmPassword) {
                        showMessage('Les mots de passe ne correspondent pas.', 'error');
                        return;
                    }

                    // Vérifier la longueur du mot de passe
                    if (password.length < 6) {
                        showMessage('Le mot de passe doit comporter au moins 6 caractères.', 'error');
                        return;
                    }

                    // Désactiver le bouton de soumission
                    const submitBtn = registerForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inscription...';
                    }

                    try {
                        console.log("Début de l'inscription...");

                        // Vérifier si c'est le premier utilisateur (pour en faire un admin)
                        const { count, error: countError } = await supabaseClient
                            .from('users')
                            .select('*', { count: 'exact', head: true });

                        if (countError) {
                            console.error("Erreur lors du comptage des utilisateurs:", countError);
                        }

                        console.log("Nombre d'utilisateurs existants:", count);
                        const isFirstUser = count === 0 || count === null;

                        // 1. Créer l'utilisateur dans Supabase Auth
                        console.log("Création de l'utilisateur dans Auth...");
                        const { data, error } = await supabaseClient.auth.signUp({
                            email: email,
                            password: password
                        });

                        if (error) throw error;

                        console.log("Utilisateur créé dans Auth:", data);

                        // 2. Ajouter l'utilisateur à la table users personnalisée
                        console.log("Ajout de l'utilisateur dans la table users...");
                        const { data: userData, error: userError } = await supabaseClient
                            .from('users')
                            .insert([
                                {
                                    id: data.user.id,
                                    name: name,
                                    email: email,
                                    is_admin: isFirstUser, // Seul le premier utilisateur est admin
                                    created_at: new Date().toISOString()
                                }
                            ]);

                        if (userError) {
                            console.error("Erreur lors de l'insertion dans users:", userError);
                            throw userError;
                        }

                        console.log("Utilisateur ajouté à la table users avec succès!");

                        showMessage('Compte créé avec succès ! Vous pouvez maintenant vous connecter.', 'success');

                        // Si c'est le premier utilisateur (et donc admin), afficher un message spécial
                        if (isFirstUser) {
                            showMessage('Vous êtes le premier utilisateur, vous avez été désigné comme administrateur !', 'success');
                        }

                        // Rediriger vers la page de connexion
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } catch (error) {
                        console.error("Erreur lors de l'inscription:", error);

                        let errorMessage = 'Erreur lors de l\'inscription.';
                        if (error.message) {
                            if (error.message.includes('already registered')) {
                                errorMessage = 'Cet email est déjà utilisé.';
                            } else {
                                errorMessage = 'Erreur: ' + error.message;
                            }
                        }

                        showMessage(errorMessage, 'error');

                        // Réactiver le bouton
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = "S'inscrire";
                        }
                    }
                });
            }
        }
    </script>
</body>

</html>